name: Close Pull Request

# only trigger on pull request closed events
on:
  pull_request:
    types: [ closed ]

jobs:
  merge_job:
    # this job will only run if the PR has been merged
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
    - name: Gets the target repository PR
      env:
        PR_BRANCH: ${{ github.head_ref || github.ref_name }}
      run: |
        echo REP: $(curl -L -X GET -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{ secrets.TARGET_REPO_TOKEN }}"  -H "X-GitHub-Api-Version: 2022-11-28"   https://api.github.com/repos/nsarlin-zama/test-target-repo/pulls -d '{ "head": "nsarlin_zama:${PR_BRANCH}", "state": "open" }'  | jq '.[0].url')
    - run: |
        echo PR #${{ github.event.number }} has been merged

  close_job:
    # this job will only run if the PR has been closed without being merged
    if: github.event.pull_request.merged == false
    runs-on: ubuntu-latest
    steps:
    - run: |
        echo PR #${{ github.event.number }} has been closed without being merged

    - name: Find Pull Request
      env:
        PR_BRANCH: ${{ github.head_ref || github.ref_name }}
      run: |
        echo REP: $(curl -L -X GET -H "Accept: application/vnd.github+json"  -H "X-GitHub-Api-Version: 2022-11-28"   https://api.github.com/repos/nsarlin-zama/test-target-repo/pulls -d '{ "head": "nsarlin_zama:${PR_BRANCH}", "state": "open" }'  | jq '.[0].url')
    - run: |
        echo PR #${{ github.event.number }} has been merged

      # uses: juliangruber/find-pull-request-action@v1
      # id: find-pull-request
      # with:
      #   branch: "${{ github.head_ref || github.ref_name }}"
      #   repo: nsarlin-zama/test-target-repo

    # - name: Close Pull
    #   uses: peter-evans/close-pull@v3
    #   with:
    #     pull-request-number: ${{ steps.find-pull-request.outputs.number }}
    #     comment: Auto-closing data pull request because the associated branch on main repo was closed.
    #     delete-branch: true
    # - run: echo "Pull Request ${number} (${sha})"
    #   env:
    #     number: ${{ steps.find-pull-request.outputs.number }}
    #     sha: ${{ steps.find-pull-request.outputs.head-sha }}
